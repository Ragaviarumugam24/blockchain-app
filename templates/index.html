<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Blockchain Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Toasts & Icons -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #f8fafc;
    }
    .block {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    .navbar {
      background: #0d6efd;
    }
    .navbar-brand {
      color: white !important;
      font-weight: bold;
    }
    footer {
      text-align: center;
      color: gray;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üîó Blockchain Dashboard</a>
    </div>
  </nav>

  <div class="container my-4">

    <!-- Node Selection -->
    <div class="mb-4">
      <label for="nodeSelect" class="form-label fw-bold">üåç Select Node:</label>
      <select id="nodeSelect" class="form-select" style="max-width: 400px;">
        <option value="http://127.0.0.1:5000" selected>Node 1 (Port 5000)</option>
        <option value="http://127.0.0.1:5001">Node 2 (Port 5001)</option>
        <option value="http://127.0.0.1:5002">Node 3 (Port 5002)</option>
      </select>
    </div>

    <!-- Blockchain Display -->
    <h3 class="mb-3">üìò Blockchain</h3>
    <div id="blockchain"></div>

    <!-- Add Transaction -->
    <div class="card my-4">
      <div class="card-body">
        <h5 class="card-title">üí∞ Add Transaction</h5>
        <form id="txForm">
          <div class="mb-2">
            <input class="form-control" type="text" id="sender" placeholder="Sender" required>
          </div>
          <div class="mb-2">
            <input class="form-control" type="text" id="recipient" placeholder="Recipient" required>
          </div>
          <div class="mb-3">
            <input class="form-control" type="number" id="amount" placeholder="Amount" required>
          </div>
          <button class="btn btn-success" type="submit">Add Transaction</button>
        </form>
      </div>
    </div>

    <!-- Mine & Resolve -->
    <div class="d-flex gap-2">
      <button class="btn btn-primary" id="mineBtn">‚öíÔ∏è Mine a Block</button>
      <button class="btn btn-warning" id="resolveBtn">üåê Resolve Chain</button>
    </div>

    <!-- Toast Notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
      <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body" id="toastMsg">Action completed!</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

  </div>

  <footer>
    <p>‚öôÔ∏è Local Blockchain Demo ‚Äî Flask + Bootstrap + JS Auto Refresh</p>
  </footer>

  <script>
    const nodeSelect = document.getElementById('nodeSelect');
    const blockchainDiv = document.getElementById('blockchain');
    const toastEl = document.getElementById('liveToast');
    const toastMsg = document.getElementById('toastMsg');
    const toast = new bootstrap.Toast(toastEl);

    function showToast(message, color="primary") {
      toastEl.classList.remove('text-bg-primary', 'text-bg-success', 'text-bg-danger');
      toastEl.classList.add(`text-bg-${color}`);
      toastMsg.textContent = message;
      toast.show();
    }

    async function loadBlockchain() {
      const NODE_URL = nodeSelect.value;
      try {
        const res = await fetch(`${NODE_URL}/chain`);
        const data = await res.json();
        blockchainDiv.innerHTML = "";
        data.chain.forEach(block => {
          const txList = block.transactions.map(tx => `<li>${tx.sender} ‚Üí ${tx.recipient} : ${tx.amount}</li>`).join("");
          blockchainDiv.innerHTML += `
            <div class="block">
              <strong>Block #${block.index}</strong><br>
              <small><b>Previous Hash:</b> ${block.previous_hash}</small><br>
              <small><b>Proof:</b> ${block.proof}</small><br>
              <b>Transactions:</b>
              <ul>${txList || "<li>No transactions</li>"}</ul>
            </div>`;
        });
      } catch (err) {
        blockchainDiv.innerHTML = `<div class="alert alert-danger">Error loading blockchain data: ${err}</div>`;
      }
    }

    // Auto-refresh every 10s
    setInterval(loadBlockchain, 10000);
    nodeSelect.addEventListener('change', loadBlockchain);
    loadBlockchain();

    // Add transaction
    document.getElementById('txForm').addEventListener('submit', async e => {
      e.preventDefault();
      const NODE_URL = nodeSelect.value;
      const sender = document.getElementById('sender').value;
      const recipient = document.getElementById('recipient').value;
      const amount = document.getElementById('amount').value;
      try {
        const res = await fetch(`${NODE_URL}/transactions/new`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({sender, recipient, amount: parseInt(amount)})
        });
        if (res.ok) showToast("Transaction added!", "success");
        loadBlockchain();
      } catch (err) {
        showToast("Error adding transaction!", "danger");
      }
    });

    // Mine block
    document.getElementById('mineBtn').addEventListener('click', async () => {
      const NODE_URL = nodeSelect.value;
      try {
        await fetch(`${NODE_URL}/mine`);
        showToast("New block mined!", "success");
        loadBlockchain();
      } catch (err) {
        showToast("Mining failed!", "danger");
      }
    });

    // Resolve conflicts
    document.getElementById('resolveBtn').addEventListener('click', async () => {
      const NODE_URL = nodeSelect.value;
      try {
        await fetch(`${NODE_URL}/nodes/resolve`);
        showToast("Chain resolved!", "success");
        loadBlockchain();
      } catch (err) {
        showToast("Conflict resolution failed!", "danger");
      }
    });
  </script>

</body>
</html>
